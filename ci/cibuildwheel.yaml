trigger: none

stages:
  - stage: cibuildwheel
    condition: eq(variables['System.PullRequest.IsFork'], 'false')
    jobs:
      - job: start_linux_arm64_agent_aws
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: none
          - bash: |
              echo "buildno: $(Build.BuildId)"
              echo ${AZURE_DEVOPS_CLI_PAT} | az devops login
            env:
              AZURE_DEVOPS_CLI_PAT: $(System.AccessToken)
            displayName: "Login Azure DevOps Extension"
          - bash:
              az devops configure --defaults
              organization=$(System.TeamFoundationCollectionUri)
              project=$(System.TeamProject) --use-git-aliases true
            displayName: "Set default Azure DevOps organization and project"
          - task: LambdaInvokeFunction@1
            displayName: "Start Agent 1"
            name: "Start_Agent1"
            inputs:
              awsCredentials: "ondemand-dev"
              regionName: "eu-west-1"
              functionName: "ondemand-pipeline"
              payload: |
                {
                  "pool": "arm64-clients",
                  "buildid": "$(Build.BuildId)"
                }
              outputVariable: "functionResult"
          - bash: |
              echo "Instance: $(functionResult)"
            name: "Display_Instance"
            displayName: "Display Instance"
          - bash: |
              echo "Starting agent... for pool arm64-clients"
              POOLID=$(az pipelines pool list | jq '.[]| select(.name == "arm64-clients") | .id' -r)
              while [ "$(az pipelines agent list --pool-id $POOLID | jq '.[]| select(.name == "arm64-clients-$(Build.BuildId)") | .enabled' -r)" != "true" ]
              do
                echo "Still waiting for agent arm64-clients-$(Build.BuildId) ... "
                sleep 3
              done
              echo "Agent found ..."
            name: "Check_agent"
            displayName: "Check agent"
            timeoutInMinutes: 20
      - job: linux_arm64
        pool:
          name: "arm64-clients"
          demands:
            - Agent.Name -equals arm64-clients-$(Build.BuildId)
        dependsOn:
          - start_linux_arm64_agent_aws
        timeoutInMinutes: 90
        condition: eq(variables['System.PullRequest.IsFork'], 'false')
        steps:
          - checkout: self
            fetchDepth: 1
            lfs: false
            submodules: true
          # - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - bash: cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}

      - job: linux_x64_cpython_manylinux_x86_64
        pool: {vmImage: 'ubuntu-latest'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - bash: cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
            env:
              CIBW_BUILD: cp*-manylinux_x86_64
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}

      - job: linux_x64_cpython_musllinux
        pool: {vmImage: 'ubuntu-latest'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - bash: cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
            env:
              CIBW_BUILD: cp*-musllinux*
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}

      - job: linux_x64_pypy
        pool: {vmImage: 'ubuntu-latest'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - bash: cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
            env:
              CIBW_BUILD: pp*
              CIBW_ENABLE: pypy pypy-eol
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}

      - job: macos_x64
        pool: {vmImage: 'macOS-13'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - bash: cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: wheelhouse}

      - job: windows_i686
        pool: {vmImage: 'windows-2019'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - powershell: |
              $vsPath = Resolve-Path "C:\Program Files (x86)\Microsoft Visual Studio\2019\*\VC\Auxiliary\Build\vcvars32.bat"
              cmd /c "call `"$vsPath`" && set > env_vars.txt"

              Get-Content env_vars.txt | ForEach-Object {
                if ($_ -match "^([^=]+?)=(.*)$" -and $matches[1] -notmatch '^(SYSTEM|AGENT|BUILD|RELEASE|VSTS|TASK|USE_|FAIL_|MSDEPLOY|AZP_75787|AZP_AGENT|AZP_ENABLE|AZURE_HTTP|COPYFILESOVERSSHV0|ENABLE_ISSUE_SOURCE_VALIDATION|MODIFY_NUMBER_OF_RETRIES_IN_ROBOCOPY|MSBUILDHELPERS_ENABLE_TELEMETRY|RETIRE_AZURERM_POWERSHELL_MODULE|ROSETTA2_WARNING|AZP_PS_ENABLE)') {
                  [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
                  Write-Host "##vso[task.setvariable variable=$($matches[1])]$($matches[2])"
                }
              }

              where.exe cl.exe
              cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
            env:
              CIBW_ENVIRONMENT: "MSSdk=1 DISTUTILS_USE_SDK=1 SETUP_DO_GIT_SUBMODULE_INIT=1"
              CIBW_BUILD: "*win32*"
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}

      - job: windows_x86_64
        pool: {vmImage: 'windows-2019'}
        timeoutInMinutes: 90
        steps:
          - task: UsePythonVersion@0
          - bash: |
              set -o errexit
              python3 -m pip install --upgrade pip
              python3 -m pip install cibuildwheel
            displayName: Install dependencies
          - powershell: |
              $vsPath = Resolve-Path "C:\Program Files (x86)\Microsoft Visual Studio\2019\*\VC\Auxiliary\Build\vcvars64.bat"
              cmd /c "call `"$vsPath`" && set > env_vars.txt"

              Get-Content env_vars.txt | ForEach-Object {
                if ($_ -match "^([^=]+?)=(.*)$" -and $matches[1] -notmatch '^(SYSTEM|AGENT|BUILD|RELEASE|VSTS|TASK|USE_|FAIL_|MSDEPLOY|AZP_75787|AZP_AGENT|AZP_ENABLE|AZURE_HTTP|COPYFILESOVERSSHV0|ENABLE_ISSUE_SOURCE_VALIDATION|MODIFY_NUMBER_OF_RETRIES_IN_ROBOCOPY|MSBUILDHELPERS_ENABLE_TELEMETRY|RETIRE_AZURERM_POWERSHELL_MODULE|ROSETTA2_WARNING|AZP_PS_ENABLE)') {
                  [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
                  Write-Host "##vso[task.setvariable variable=$($matches[1])]$($matches[2])"
                }
              }

              where.exe cl.exe
              cibuildwheel --output-dir wheelhouse .
            displayName: Build wheels
            env:
              CIBW_BUILD: "*win_amd64*"
              CIBW_ENVIRONMENT: "MSSdk=1 DISTUTILS_USE_SDK=1 SETUP_DO_GIT_SUBMODULE_INIT=1"
              CIBW_BUILD_VERBOSITY: "3"
              DISTUTILS_DEBUG: "1"
          - task: PublishBuildArtifacts@1
            inputs: {pathtoPublish: 'wheelhouse'}
